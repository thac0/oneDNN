<!-- HTML header for doxygen 1.8.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>Intel(R) MKL-DNN: Performance profiling</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Intel(R) Math Kernel Library for Deep Neural Networks (Intel(R) MKL-DNN)
   &#160;<span id="projectnumber">0.21.5</span>
   </div>
   <div id="projectbrief">Performance library for Deep Learning</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Performance profiling </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>It is often useful to collect information about how much of an application run time is spent executing Intel(R) MKL-DNN primitives and which of those take the most time. One of the popular methods to do this is to use profilers like Linux* perf or Intel(R) VTune(tm) Amplifier. Currently, Intel MKL-DNN has very limited support for these tools since it does not annotate code generated at run-time and thus the profiles cannot properly attribute it. However, Intel MKL-DNN implements another feature called <em>verbose mode</em> that allows tracing execution of Intel MKL-DNN primitives and collection of basic statistics like execution time and primitive parameters.</p>
<h2>Verbose mode</h2>
<p>To enable Intel MKL-DNN verbose mode, set <code>MKLDNN_VERBOSE</code> environment variable to <code>1</code> (to dump only execution time) or <code>2</code> (to dump both execution and creation time). For example:</p>
<p>``` $ export MKLDNN_VERBOSE=1 $ ./benchdnn &ndash;conv ic16ih7oc16oh7kh5ph2n"wip" ```</p>
<p>This will produce the following output (the line break was added to fit into the page width):</p>
<p>``` mkldnn_verbose,info,Intel(R) MKL-DNN v0.18.0 (Git Hash 4cfed5bf82f1339d7c8c7f622fda02dc00ec8ad8), \ Intel(R) Advanced Vector Extensions 2 (Intel(R) AVX2) mkldnn_verbose,exec,reorder,jit:uni,undef,in:f32_nchw out:f32_nChw8c,num:1,2x16x7x7,0.529053 mkldnn_verbose,exec,reorder,jit:uni,undef,in:f32_oihw out:f32_OIhw8i8o,num:1,16x16x5x5,0.98999 mkldnn_verbose,exec,reorder,jit:uni,undef,in:f32_nchw out:f32_nChw8c,num:1,2x16x7x7,0.453125 mkldnn_verbose,exec,reorder,simple:any,undef,in:f32_x out:f32_x,num:1,16,0.388916 mkldnn_verbose,exec,convolution,jit:avx2,forward_training,fsrc:nChw8c fwei:OIhw8i8o fbia:x \ fdst:nChw8c,alg:convolution_direct,mb2_ic16oc16_ih7oh7kh5sh1dh0ph2_iw7ow7kw5sw1dw0pw2,0.0241699 mkldnn_verbose,exec,reorder,jit:uni,undef,in:f32_nChw8c out:f32_nchw,num:1,2x16x7x7,0.469971 0:PASSED __REPRO: ic16ih7oc16oh7kh5ph2nwip tests:1 passed:1 skipped:0 mistrusted:0 unimplemented:0 failed:0 ```</p>
<p>The first line of verbose information contains the build version and git hash, if available, as well as the supported instruction set architechture. Each subsequent line of verbose information is formatted as a comma-separated list containing:</p>
<ul>
<li><code>mkldnn_verbose</code></li>
<li><code>stage</code>, e.g. <code>create</code> or <code>exec</code></li>
<li><code>primitive-kind</code>, e.g. <code>convolution</code>, <code>reorder</code>, <code>sum</code>, ...</li>
<li>primitive implementation name</li>
<li>propagation-kind, e.g. <code>forward_training</code></li>
<li>input/output data info, e.g. data type and data format</li>
<li>auxiliary information, e.g. algorithm or number of input</li>
<li>problem description<ul>
<li>for convolution the problem description is dumped in benchdnn friendly format</li>
<li>for reorder, sum, and concat problem description is simply logical dims</li>
<li>for other primitives the problem description is similar to convolution one</li>
</ul>
</li>
<li>execution time in milliseconds</li>
</ul>
<p>To get more information about verbose report format please refer to the <code>verbose_templ()</code> function in the <a href="https://github.com/intel/mkl-dnn/blob/master/src/common/verbose.hpp">src/common/verbose.hpp</a> file. </p>
<hr/>
<p> <b>NOTE</b> The format is subject to change </p>
<hr/>
<hr/>
<p> <b>WARNING</b> Verbose mode has non-negligible performance impact especially if the output rate is high. </p>
<hr/>
<h2>Intel(R) VTune(TM) profiling</h2>
<p>To collect performance data of JIT-kernels set <code>VTUNEROOT</code> environment variable to path to VTune before building of Intel MKL-DNN. For example:</p>
<p>``` $ mkdir -p build &amp;&amp; cd build &amp;&amp; cmake -DVTUNEROOT=/path/to/vtune .. &amp;&amp; make ```</p>
<h2>Dump JIT-kernels</h2>
<p>To dump JIT-kernels set MKLDNN_JIT_DUMP environment variable to <code>1</code>. For example:</p>
<p>``` $ export MKLDNN_JIT_DUMP=1 $ ./simple-net-c ```</p>
<p>This will produce the following output files: </p>
<pre class="fragment">mkldnn_dump_jit_uni_reorder_kernel_f32.0.bin
mkldnn_dump_jit_avx2_conv_fwd_kernel_f32.1.bin
mkldnn_dump_jit_uni_relu_kernel_f32.2.bin
mkldnn_dump_jit_uni_lrn_fwd_kernel_f32.3.bin
mkldnn_dump_jit_uni_lrn_fwd_kernel_f32.4.bin
mkldnn_dump_jit_uni_lrn_fwd_kernel_f32.5.bin
mkldnn_dump_jit_uni_reorder_kernel_f32.6.bin
mkldnn_dump_jit_uni_pool_kernel_f32.7.bin
</pre><p>To open these files any disassembler can be used. For example:</p>
<p>``` $ xed -64 -ir mkldnn_dump_jit_avx2_conv_fwd_kernel_f32.1.bin XDIS 0: PUSH BASE 53 push rbx XDIS 1: PUSH BASE 55 push rbp XDIS 2: PUSH BASE 4154 push r12 XDIS 4: PUSH BASE 4155 push r13 XDIS 6: PUSH BASE 4156 push r14 XDIS 8: PUSH BASE 4157 push r15 XDIS a: DATAXFER BASE 488B07 mov rax, qword ptr [rdi] XDIS d: DATAXFER BASE 488B7708 mov rsi, qword ptr [rdi+0x8] XDIS 11: DATAXFER BASE 488B5710 mov rdx, qword ptr [rdi+0x10] XDIS 15: DATAXFER BASE 488B5F18 mov rbx, qword ptr [rdi+0x18] XDIS 19: DATAXFER BASE 488B8F98000000 mov rcx, qword ptr [rdi+0x98] XDIS 20: DATAXFER BASE 448BAF00010000 mov r13d, dword ptr [rdi+0x100] XDIS 27: DATAXFER BASE 4C8BB7D0000000 mov r14, qword ptr [rdi+0xd0] XDIS 2e: BINARY BASE 4983FE04 cmp r14, 0x4 XDIS 32: COND_BR BASE 0F85EF030000 jnz 0x427 XDIS 38: LOGICAL BASE 4D31DB xor r11, r11 XDIS 3b: LOGICAL BASE 41F7C510000000 test r13d, 0x10 XDIS 42: COND_BR BASE 0F8558000000 jnz 0xa0 XDIS 48: DATAXFER AVX C5FC1006 vmovups ymm0, ymmword ptr [rsi] XDIS 4c: DATAXFER AVX C5FC104E20 vmovups ymm1, ymmword ptr [rsi+0x20] XDIS 51: DATAXFER AVX C5FC105640 vmovups ymm2, ymmword ptr [rsi+0x40] XDIS 56: DATAXFER AVX C5FC109E207A0100 vmovups ymm3, ymmword ptr [rsi+0x17a20] ... ```</p>
<p><a class="el" href="legal_information.html">Legal information</a> </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.5
</small></address>
</body>
</html>
